<UserControl x:Class="SchoolMedicalWpf.App.Nurse.HealthSchedulePage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:SchoolMedicalWpf.App.Nurse"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1400">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Ghi nhận kết quả khám sức khỏe và tiêm chủng" 
                       FontSize="20" FontWeight="Bold" Margin="0,0,0,5"/>
            <TextBlock Name="txtCurrentDateTime" Text="2025-07-04 05:28:41 UTC - User: danielleit241" 
                       FontSize="12" Foreground="Gray"/>
        </StackPanel>

        <!-- Schedule Selection Panel -->
        <Border Grid.Row="1" BorderBrush="#E0E0E0" BorderThickness="1" 
                Background="#F8F9FA" Padding="15" CornerRadius="5" Margin="0,0,0,15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Schedule Selection -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <Button Name="btnSelectSchedule" Content="📅 Chọn Schedule đang diễn ra" 
                            Padding="12,8" FontSize="14" Background="#007bff" Foreground="White"
                            BorderThickness="0" Click="SelectSchedule_Click"/>
                    <TextBlock Name="txtActiveSchedulesCount" Text="(Đang tải...)" 
                               VerticalAlignment="Center" Margin="10,0,0,0" Foreground="Gray"/>
                </StackPanel>

                <!-- Selected Schedule Info -->
                <Border Grid.Row="1" Name="pnlSelectedSchedule" Visibility="Collapsed"
                        Background="White" BorderBrush="#28a745" BorderThickness="2" 
                        CornerRadius="5" Padding="12" Margin="0,5,0,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Name="txtSelectedScheduleTitle" FontWeight="Bold" FontSize="16"/>
                            <TextBlock Name="txtSelectedScheduleInfo" Foreground="Gray" Margin="0,3,0,0"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <Button Name="btnLoadStudents" Content="👥 Tải danh sách sinh viên" 
                                    Padding="10,6" Background="#28a745" Foreground="White" BorderThickness="0"
                                    Click="LoadStudents_Click" Margin="0,0,5,0"/>
                            <Button Name="btnChangeSchedule" Content="🔄 Đổi Schedule" 
                                    Padding="8,6" Background="#6c757d" Foreground="White" BorderThickness="0"
                                    Click="SelectSchedule_Click"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- No Schedule Selected -->
                <TextBlock Grid.Row="2" Name="txtNoScheduleMessage" 
                          Text="Chưa chọn schedule. Vui lòng nhấn nút 'Chọn Schedule đang diễn ra' để bắt đầu."
                          HorizontalAlignment="Center" Foreground="Gray" FontStyle="Italic"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="2" Name="tcMain" Visibility="Collapsed">
            <!-- Students List Tab -->
            <TabItem Header="📋 Danh sách sinh viên">
                <Grid Margin="10">
                    <DataGrid Name="dgStudents" AutoGenerateColumns="False" 
                              CanUserAddRows="False" CanUserDeleteRows="False"
                              GridLinesVisibility="Horizontal" AlternatingRowBackground="#F8F9FA"
                              HeadersVisibility="Column" RowHeight="35">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Mã SV" Binding="{Binding StudentCode}" Width="90" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Họ và tên" Binding="{Binding StudentName}" Width="180" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Lớp" Binding="{Binding Grade}" Width="70" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="Đã thực hiện" Binding="{Binding IsCompleted}" Width="100"/>

                            <DataGridTemplateColumn Header="Ngày thực hiện" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <DatePicker SelectedDate="{Binding DatePerformed}" IsEnabled="{Binding IsCompleted}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Trạng thái" Width="140">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="3" Padding="6,2">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="LightGray"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="Chưa thực hiện">
                                                            <Setter Property="Background" Value="#FFF3CD"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã có kết quả">
                                                            <Setter Property="Background" Value="#D1ECF1"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu kết quả khám">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu kết quả tiêm">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã cập nhật kết quả">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu cơ bản">
                                                            <Setter Property="Background" Value="#E2E3E5"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Status}" FontSize="11" HorizontalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Ghi chú" Binding="{Binding Notes}" Width="150"/>

                            <!-- Updated Action Column with 3 buttons -->
                            <DataGridTemplateColumn Header="Thao tác" Width="220">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <!-- Nút nhập kết quả mới (chỉ hiện khi chưa có kết quả và đã completed) -->
                                            <Button Content="📝 Nhập" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#17a2b8" Foreground="White" BorderThickness="0"
                                                    Click="EnterResults_Click"
                                                    IsEnabled="{Binding IsCompleted}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <!-- Hiện khi: IsCompleted = true VÀ HasExistingResults = false -->
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding IsCompleted}" Value="True"/>
                                                                    <Condition Binding="{Binding HasExistingResults}" Value="False"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- Nút xem kết quả (chỉ hiện khi đã có kết quả) -->
                                            <Button Content="👁️ Xem" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#28a745" Foreground="White" BorderThickness="0"
                                                    Click="ViewResult_Click"
                                                    IsEnabled="{Binding HasExistingResults}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasExistingResults}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- Nút chỉnh sửa kết quả (chỉ hiện khi đã có kết quả) -->
                                            <Button Content="✏️ Sửa" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#ffc107" Foreground="Black" BorderThickness="0"
                                                    Click="EditResult_Click"
                                                    IsEnabled="{Binding HasExistingResults}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasExistingResults}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <!-- Results Summary Tab -->
            <TabItem Header="📊 Tổng hợp kết quả">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Statistics -->
                    <Border Grid.Row="0" Background="#F8F9FA" Padding="15" CornerRadius="5" Margin="0,0,0,15">
                        <StackPanel Orientation="Horizontal">
                            <Border Background="#e3f2fd" Padding="10,8" CornerRadius="5" Margin="0,0,15,0">
                                <StackPanel>
                                    <TextBlock Text="Tổng sinh viên" FontSize="12" Foreground="Gray"/>
                                    <TextBlock Name="txtTotalStudents" Text="0" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <Border Background="#e8f5e8" Padding="10,8" CornerRadius="5" Margin="0,0,15,0">
                                <StackPanel>
                                    <TextBlock Text="Đã hoàn thành" FontSize="12" Foreground="Gray"/>
                                    <TextBlock Name="txtCompletedStudents" Text="0" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <Border Background="#fff3cd" Padding="10,8" CornerRadius="5">
                                <StackPanel>
                                    <TextBlock Text="Chưa hoàn thành" FontSize="12" Foreground="Gray"/>
                                    <TextBlock Name="txtPendingStudents" Text="0" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>

                    <!-- Results Summary -->
                    <DataGrid Grid.Row="1" Name="dgResultsSummary" AutoGenerateColumns="False" 
                              IsReadOnly="True" GridLinesVisibility="Horizontal">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Mã SV" Binding="{Binding StudentCode}" Width="90" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Họ và tên" Binding="{Binding StudentName}" Width="180" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Lớp" Binding="{Binding Grade}" Width="70" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="Đã thực hiện" Binding="{Binding IsCompleted}" Width="100"/>

                            <DataGridTemplateColumn Header="Ngày thực hiện" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <DatePicker SelectedDate="{Binding DatePerformed}" IsEnabled="False"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Trạng thái" Width="140">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="3" Padding="6,2">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="LightGray"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="Chưa thực hiện">
                                                            <Setter Property="Background" Value="#FFF3CD"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã có kết quả">
                                                            <Setter Property="Background" Value="#D1ECF1"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu kết quả khám">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu kết quả tiêm">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã cập nhật kết quả">
                                                            <Setter Property="Background" Value="#D4EDDA"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Đã lưu cơ bản">
                                                            <Setter Property="Background" Value="#E2E3E5"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Status}" FontSize="11" HorizontalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Ghi chú" Binding="{Binding Notes}" Width="150"/>

                            <!-- Same 3-button logic for summary tab -->
                            <DataGridTemplateColumn Header="Thao tác" Width="220">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <!-- Nút nhập kết quả mới -->
                                            <Button Content="📝 Nhập" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#17a2b8" Foreground="White" BorderThickness="0"
                                                    Click="EnterResults_Click"
                                                    IsEnabled="{Binding IsCompleted}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding IsCompleted}" Value="True"/>
                                                                    <Condition Binding="{Binding HasExistingResults}" Value="False"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- Nút xem kết quả -->
                                            <Button Content="👁️ Xem" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#28a745" Foreground="White" BorderThickness="0"
                                                    Click="ViewResult_Click"
                                                    IsEnabled="{Binding HasExistingResults}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasExistingResults}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- Nút chỉnh sửa kết quả -->
                                            <Button Content="✏️ Sửa" Padding="4,2" Margin="1" FontSize="10"
                                                    Background="#ffc107" Foreground="Black" BorderThickness="0"
                                                    Click="EditResult_Click"
                                                    IsEnabled="{Binding HasExistingResults}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasExistingResults}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- No Data Message -->
        <StackPanel Grid.Row="2" Name="pnlNoData" HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBlock Text="📋" FontSize="48" HorizontalAlignment="Center" Opacity="0.3"/>
            <TextBlock Text="Chưa có dữ liệu sinh viên" FontSize="16" 
                       HorizontalAlignment="Center" Foreground="Gray" Margin="0,10,0,0"/>
            <TextBlock Text="Vui lòng chọn schedule và tải danh sách sinh viên" 
                       FontSize="12" HorizontalAlignment="Center" Foreground="LightGray"/>
        </StackPanel>

        <!-- Action Panel -->
        <Border Grid.Row="3" Background="#F8F9FA" Padding="15" CornerRadius="5" Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Name="txtLastUpdate" Text="" Foreground="Gray"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Name="btnSaveAll" Content="💾 Lưu tất cả" Padding="15,8" 
                            Background="#28a745" Foreground="White" BorderThickness="0"
                            Click="SaveAll_Click" IsEnabled="False" Margin="0,0,10,0"/>
                    <Button Name="btnRefresh" Content="🔄 Làm mới" Padding="12,8" 
                            Background="#6c757d" Foreground="White" BorderThickness="0"
                            Click="Refresh_Click"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>